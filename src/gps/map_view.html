<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>GPS-based Navigation</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <link rel="stylesheet" href="static/leaflet.css" />
  <script src="static/leaflet.js"></script>
  <script src="static/leaflet.rotatedMarker.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }

    /* ───── 20 : 80 상-하 분할 ───── */
    .container      { display: flex; flex-direction: column; height: 100%; }
    #mapPane   { flex: 3 0 0; min-height: 0; position: relative; }
        #map       { width: 100%; height: 100%; }

	    #cameraPane{ flex: 2 0 0; min-height: 0;
		                     display: flex; align-items: center; justify-content: center;
				                      background: #000; }
        #camView   { width: 100%; height: 100%; object-fit: contain; }
    .statusBox      { position: fixed; top: 8px; right: 8px; z-index: 1000;
                      background: rgba(255,255,255,.8); padding: 6px 10px;
                      border: 1px solid #999; font: 14px/1.3 sans-serif;
                      max-width: 320px; }
    #statusText     { margin-top: 10px; }
  </style>
</head>
<body>

<div class="container">
  <!-- 상단 20 % : 카메라 -->
  <!-- 하단 80 % : 지도 -->
  <div id="mapPane"><div id="map"></div></div>
  <div id="cameraPane">
    <img id="camView" src="/camera?fps=3" alt="camera stream" />
  </div>


</div>

<!-- 상태·컨트롤 박스 -->
<div class="statusBox">
  <div>
    <button id="missionBtn">Start Mission</button>
    <select id="pathSelect"><option disabled selected>경로 선택</option></select>
  </div>
  <div id="statusText">GPS 대기 중…</div>
</div>


<script>
const map = L.map('map').setView([0, 0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '© OpenStreetMap'
}).addTo(map);

let live = null;
let pathLine = null;
const arrowIcon = L.icon({ iconUrl: 'static/arrow.svg', iconSize: [32,32], iconAnchor: [16,16] });
const statusText = document.getElementById('statusText');
const missionBtn = document.getElementById('missionBtn');
const pathSelect = document.getElementById('pathSelect');

fetch('/paths')
  .then(r => r.json())
  .then(paths => {
    pathSelect.innerHTML = ''; // clear default
    if (paths.length === 0) {
      const opt = document.createElement('option');
      opt.textContent = '경로 없음';
      opt.disabled = true;
      opt.selected = true;
      pathSelect.appendChild(opt);
      return;
    }

    paths.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.file;
      opt.textContent = p.file;
      pathSelect.appendChild(opt);
    });
    return fetch('/selected_path');
  })
  .then(r => r?.ok ? r.json() : null)
  .then(data => { if (data) drawPathFromData(data); });

pathSelect.addEventListener('change', () => {
  const file = pathSelect.value;
  fetch(`/set_path?file=${encodeURIComponent(file)}`)
    .then(() => fetch('/selected_path'))
    .then(r => r.json())
    .then(drawPathFromData);
});

function drawPathFromData(path) {
  if (pathLine) map.removeLayer(pathLine);
  if (!path.coords.length) return;

  const latlngs = path.coords.map(c => L.latLng(c[0], c[1]));
  pathLine = L.polyline(latlngs, { color: 'blue', weight: 4 }).addTo(map);
  map.fitBounds(L.latLngBounds(latlngs), { padding: [40, 40] });

  // L.marker(latlngs[0]).addTo(map);
  // L.marker(latlngs.at(-1)).addTo(map);

  L.marker(latlngs[0], {
      icon: new L.Icon({iconUrl:"static/images/marker-icon-green.png",
			shadowUrl:"static/images/marker-shadow.png",
			iconSize:[25,41], iconAnchor:[12,41]})
  }).addTo(map);
  L.marker(latlngs.at(-1), {
      icon: new L.Icon({iconUrl:"static/images/marker-shadow.png",
			shadowUrl:"static/images/marker-shadow.png",			  
			iconSize:[25,41], iconAnchor:[12,41]})
  }).addTo(map);

}

missionBtn.addEventListener('click', () => {
  fetch('/toggle_mission')
    .then(r => r.json())
    .then(res => {
      missionBtn.textContent = res.active ? 'End Mission' : 'Start Mission';
    });
});

const evt = new EventSource('/gps');
evt.onmessage = e => {
  const d = JSON.parse(e.data);
  if (d.lat === null || d.lon === null) {
    statusText.textContent = 'GPS 신호 없음';
    if (live) { map.removeLayer(live); live = null; }
    return;
  }

  const latlng = [d.lat, d.lon];
  if (!live) {
    live = L.marker(latlng, {
      icon: arrowIcon,
      rotationAngle: d.heading || 0,
      rotationOrigin: 'center center'
    }).addTo(map);
  } else {
    live.setLatLng(latlng);
    if (d.heading !== null) live.setRotationAngle(d.heading);
  }

  statusText.textContent =
    `GPS ${d.lat.toFixed(6)}, ${d.lon.toFixed(6)} / Head(IMU) ${(d.heading??0).toFixed(3)}° / Head(odom) ${(d.heading_odom??0).toFixed(3)}° / ${d.status} / ${d.command}`;
};
</script>
</body>
</html>

